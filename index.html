<!DOCTYPE html>
<html>
<head>
<title>Test App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" id="vp">
<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<script>
//Define our global object to hold some properties
var __testApp = {
	settings: {
		office: false, //In office, or at home
		prod: false, //Use the production scripts or local scripts
		debug: true, //Add debug console script
		timers: {
			appMobi: 2500, //Milliseconds (from __testApp.init) to wait for appMobi js to fire its ready event
			wylei: 2600, //Milliseconds (from __testApp.init) to wait for wylei js to fire its ready event
			message_queue: 2500, //Milliseconds (from wylei.ready event) to wait before flushing message queue
		},
		hosts: {
			prod: 'https://s3.amazonaws.com', //Prod host name
			home: 'http://192.168.11.12', //Home host name
			office: 'http://192.168.1.15' //Office host name
		},
		paths: {
			prod: '/js.appmobi.com/', //Prod path
			home: '/~tpetty/amoauth/' //Home path
		},
		scripts: {
			static: [
				//Add static scripts here
				'http://code.jquery.com/jquery-1.9.1.min.js',
				'http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js',
				'1touchlive/onetouch.js'
			],
			dynamic: function(){
				var scripts = [
					//Add dynamic scripts here
					__testApp.paths.scripthost + __testApp.paths.scriptpath + 'wylei.js',
					__testApp.paths.localhost + '/~tpetty/testapp/jsfunc.js'
				];
				return scripts;
			},
			debug: function(){
				var scripts = [
					//Add debug only scripts here
					__testApp.paths.localhost + ':8080' + '/target/target-script-min.js',
				];
				return scripts;
			}
		}
	},
	paths: {
		localhost: '',
		scripthost: '',
		scriptpath: ''
	},
	script_queue: [],
	script_queue_length: 0,
	message_queue: [],
	isDeviceReady: false,
	timers: {
		appMobi: null,
		wylei: null
	},
	init: function(){
		ddebug('__testApp: initializing');
		this.timers.appMobi = setTimeout(function(){
			clearTimeout(__testApp.timers.wylei);
			__testApp.flushMessageQueue();
			alert('The appMobi script didnt initialize correctly.');
		}, this.settings.timers.appMobi);
		this.timers.wylei = setTimeout(function(){
			__testApp.flushMessageQueue();
			alert('The wylei script didnt initialize correctly.');
		}, this.settings.timers.wylei);
		this.paths.localhost = (this.settings.office) ? this.settings.hosts.office : this.settings.hosts.home;
		this.paths.scripthost = (this.settings.prod) ? this.settings.hosts.prod : this.paths.localhost;
		this.paths.scriptpath = (this.settings.prod) ? this.settings.paths.prod : this.settings.paths.home;
		this.script_queue = this.settings.scripts.static;
		Array.prototype.push.apply(this.script_queue, this.settings.scripts.dynamic());
		if (this.settings.debug) {
			Array.prototype.push.apply(this.script_queue, this.settings.scripts.debug());
		}
		this.script_queue_length = this.script_queue.length;
		this.loadJsScript();
	},
	loadJsScript: function(){
		if (!this.script_queue.length) return;
		var cur = this.script_queue.shift();
		ddebug('__testApp: loading ' + cur + ' (' + (this.script_queue_length - this.script_queue.length) + ' of ' + this.script_queue_length + ')');
		var randomh=Math.random();
		var script=document.createElement("script");
		script.src=cur + '?rnd=' + randomh;
		script.type="text/javascript";
		script.onload=function(){
			if (__testApp.script_queue.length) {
				__testApp.loadJsScript();
			}
		};
		script.onerror=function(){
			ddebug('__testApp: Error loading javascript.');
			alert('__testApp: loading halted due to error.');
		}
		document.getElementsByTagName("head")[0].appendChild(script);
	},
	flushMessageQueue: function(){
		this.isDeviceReady = true;
		clearTimeout(this.timers.message_queue);
		for (var i in this.message_queue) {
			console.log(this.message_queue[i]);
		}
		$('#skip_loading').click();
	}
};
function ddebug(msg){
	if (__testApp.isDeviceReady) {
		console.log(msg);
	} else {
		__testApp.message_queue.push(msg);
	}
}
document.addEventListener("wylei.ready",function(){
	__testApp.timers.message_queue = setTimeout(function(){
		__testApp.flushMessageQueue();
	}, __testApp.settings.timers.message_queue);
	clearTimeout(__testApp.timers.wylei);
	$.mobile.loading("show", {
		text: '',
		textVisible: false,
		textonly: false
	});
},false);
document.addEventListener("appMobi.device.ready",function(){
	clearTimeout(__testApp.timers.appMobi);
},false);
</script>

<style>
	body {
		background: #000;
		margin: 0;
		padding: 0;
	}
	div.ui-body-c, .ui-overlay-c {
		background: #323232;
	}
	button {
		width: 100px;
		height: 35px;
		padding: 0;
		margin: 0;
		font-size: 10px;
	}
</style>

<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
<script type="text/javascript" charset="utf-8" src="http://localhost:58888/_appMobi/appmobi.js"></script>

<script>
__testApp.init();
</script>
</head>
<body>
<div data-role="page" id="page1">
	<div data-role="content">
		<a id="skip_loading" href="#page2" onclick="$.mobile.loading('hide');" data-role="button" data-transition="flip">Skip</a>
	</div>
</div>
</body>
</html>
